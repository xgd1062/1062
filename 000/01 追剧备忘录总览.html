<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>备忘录总览版 - 数据备份与同步</title>
    <style>
        /* 保持原有样式不变 */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .date-selector {
            display: flex;
            gap: 8px;
        }

        .day-btn,
        .view-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .day-btn:hover,
        .view-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .day-btn.active,
        .view-btn.active {
            background-color: white;
            color: #2575fc;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .save-btn {
            padding: 10px 20px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .save-btn:hover {
            background-color: #ff5252;
            transform: translateY(-2px);
        }

        .memo-container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            min-height: 400px;
        }

        .entry-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .entry-row:hover {
            background-color: #f1f8ff;
        }

        .content-input {
            flex: 3;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .number-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .add-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .add-btn:hover {
            background-color: #45a049;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 18px;
            padding: 0 10px;
        }

        .current-date {
            font-size: 20px;
            font-weight: 600;
            margin: 10px 0 20px;
            color: #444;
        }

        .overview-container {
            display: none;
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            min-height: 400px;
        }

        .overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .overview-title {
            font-size: 24px;
            font-weight: 600;
            color: #2575fc;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .overview-day {
            background-color: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .overview-day:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .day-title {
            font-size: 18px;
            font-weight: 600;
            color: #444;
        }

        .day-switch {
            background-color: #e3f2fd;
            color: #2196f3;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-switch:hover {
            background-color: #bbdefb;
        }

        .overview-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .overview-entry:last-child {
            border-bottom: none;
        }

        .overview-content {
            font-weight: 500;
            color: #333;
        }

        .overview-number-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .number-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: #e0e0e0;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .number-btn:hover {
            background-color: #d0d0d0;
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        .overview-number {
            font-weight: 600;
            color: #ff6b6b;
            background-color: #fff0f0;
            padding: 2px 10px;
            border-radius: 4px;
            min-width: 40px;
            text-align: center;
        }

        .no-entries {
            color: #999;
            font-style: italic;
            padding: 10px 0;
            text-align: center;
        }

        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 10px;
            font-weight: 500;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2575fc;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .backup-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background-color: #4a5568;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .backup-btn:hover {
            background-color: #2d3748;
        }

        .backup-btn.upload {
            background-color: #38a169;
        }

        .backup-btn.upload:hover {
            background-color: #2f855a;
        }

        .backup-btn.download {
            background-color: #3182ce;
        }

        .backup-btn.download:hover {
            background-color: #2b6cb0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .modal-subtitle {
            color: #718096;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .info-box {
            background-color: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 12px 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
            color: #4a5568;
        }

        .info-box a {
            color: #3182ce;
            text-decoration: none;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background-color: #4299e1;
            color: white;
        }

        .modal-btn.primary:hover {
            background-color: #3182ce;
        }

        .modal-btn.secondary {
            background-color: #e2e8f0;
            color: #4a5568;
        }

        .modal-btn.secondary:hover {
            background-color: #cbd5e0;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #a0aec0;
        }

        .close-btn:hover {
            color: #718096;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }

            .date-selector {
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: 8px;
                -webkit-overflow-scrolling: touch;
            }

            .day-btn {
                white-space: nowrap;
            }

            .memo-container,
            .overview-container {
                padding: 15px;
            }

            .entry-row {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .content-input,
            .number-input {
                width: 100%;
                text-align: left;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .stats-summary {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .overview-entry {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .overview-content {
                margin-bottom: 8px;
            }

            .overview-number-control {
                justify-content: center;
            }

            .backup-controls {
                margin-top: 15px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div style="display: flex; gap: 15px;">
            <div class="date-selector" id="dateSelector">
                <!-- 日期按钮由JS动态生成 -->
            </div>
            <div>
                <button class="view-btn" id="dailyViewBtn" data-view="daily">每日视图</button>
                <button class="view-btn" id="overviewViewBtn" data-view="overview">总览视图</button>
            </div>
        </div>
        <button class="save-btn" id="saveBtn">保存</button>
    </div>
    <!-- 每日视图 -->
    <div class="memo-container" id="dailyView">
        <div class="current-date" id="currentDate">
            星期一
        </div>
        <div id="entriesContainer">
            <!-- 条目由JS动态生成 -->
        </div>
        <button class="add-btn" id="addBtn">+ 添加新条目</button>
    </div>
    <!-- 总览视图 -->
    <div class="overview-container" id="overviewView">
        <div class="overview-header">
            <div class="overview-title">一周备忘录总览</div>
            <div class="backup-controls">
                <button class="backup-btn upload" id="uploadBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                        <path
                            d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                    </svg>
                    上传数据
                </button>
                <button class="backup-btn download" id="downloadBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                        <path
                            d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                    </svg>
                    下载数据
                </button>
            </div>
        </div>
        <div class="stats-summary">
            <div class="stat-item">
                <div class="stat-value" id="totalEntries">0</div>
                <div class="stat-label">总条目数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="filledDays">0</div>
                <div class="stat-label">有记录的天数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highNumber">0</div>
                <div class="stat-label">最高数字</div>
            </div>
        </div>
        <div class="overview-grid" id="overviewGrid">
            <!-- 总览内容由JS动态生成 -->
        </div>
    </div>

    <!-- GitHub 备份模态框 -->
    <div class="modal" id="githubModal">
        <div class="modal-content">
            <button class="close-btn" id="closeModalBtn">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">GitHub 数据备份</h3>
                <div class="modal-subtitle" id="modalSubtitle">连接到您的 GitHub 账户进行数据备份</div>
            </div>
            <div class="input-group">
                <label class="input-label" for="githubToken">GitHub 个人访问令牌</label>
                <input type="password" id="githubToken" class="input-field" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <div class="info-box">
                    <strong>如何获取个人访问令牌？</strong>
                    <ol style="padding-left: 20px; margin-top: 5px;">
                        <li>登录 GitHub 并访问 <a href="https://github.com/settings/tokens" target="_blank">开发者设置</a></li>
                        <li>点击 "Generate new token"</li>
                        <li>选择 <strong>repo</strong> 权限范围</li>
                        <li>生成令牌并复制到这里</li>
                    </ol>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label" for="repoName">仓库名称</label>
                <input type="text" id="repoName" class="input-field" placeholder="用户名/仓库名">
                <div class="info-box">
                    格式为：<code>用户名/仓库名</code>（例如：johnsmith/memo-backup）。仓库必须已经存在且您有写入权限。
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancelBtn">取消</button>
                <button class="modal-btn primary" id="confirmBtn">确认</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化数据
        const days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
        let currentDay = new Date().getDay(); // 0为周日，1为周一...
        currentDay = currentDay === 0 ? 6 : currentDay - 1; // 调整为周一为0
        // 从本地存储加载数据或初始化
        let memoData = JSON.parse(localStorage.getItem('memoData')) || {};
        days.forEach(day => {
            if (!memoData[day]) {
                memoData[day] = [{ content: '', number: '' }];
            }
        });

        // DOM元素引用
        const githubModal = document.getElementById('githubModal');
        const githubTokenInput = document.getElementById('githubToken');
        const repoNameInput = document.getElementById('repoName');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // 备份操作类型（upload或download）
        let currentBackupOperation = null;

        // 上传失败计数器
        let uploadFailureCount = parseInt(localStorage.getItem('uploadFailureCount')) || 0;

        // UTF8与Base64兼容转换工具
        const Utf8Base64 = {
            encode: (str) => {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                    return String.fromCharCode('0x' + p1);
                }));
            },
            decode: (base64Str) => {
                try {
                    return decodeURIComponent(atob(base64Str).split('').map(char => {
                        return '%' + ('00' + char.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                } catch (e) {
                    throw new Error('Base64解码失败，文件格式异常');
                }
            }
        };

        // 检查是否有成功记录的标志
        function hasSuccessfulRecord() {
            return localStorage.getItem('githubLastSuccess') === 'true';
        }

        // 标记成功记录
        function markSuccessfulRecord() {
            localStorage.setItem('githubLastSuccess', 'true');
            // 成功后重置失败计数器
            uploadFailureCount = 0;
            localStorage.setItem('uploadFailureCount', '0');
        }

        // 封装本地保存函数
        function saveToLocalStorage() {
            localStorage.setItem('memoData', JSON.stringify(memoData));
            console.log('本地数据已同步保存');
        }

        // 生成日期选择器
        const dateSelector = document.getElementById('dateSelector');
        days.forEach((day, index) => {
            const btn = document.createElement('button');
            btn.className = 'day-btn';
            btn.textContent = day;
            if (index === currentDay) btn.classList.add('active');
            btn.onclick = () => {
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDay = index;
                document.getElementById('currentDate').textContent = days[currentDay];
                renderEntries();
                switchView('daily');
            };
            dateSelector.appendChild(btn);
        });

        // 视图切换功能
        const dailyView = document.getElementById('dailyView');
        const overviewView = document.getElementById('overviewView');
        const dailyViewBtn = document.getElementById('dailyViewBtn');
        const overviewViewBtn = document.getElementById('overviewViewBtn');
        dailyViewBtn.classList.add('active');
        function switchView(viewType) {
            if (viewType === 'daily') {
                dailyView.style.display = 'block';
                overviewView.style.display = 'none';
                dailyViewBtn.classList.add('active');
                overviewViewBtn.classList.remove('active');
            } else {
                dailyView.style.display = 'none';
                overviewView.style.display = 'block';
                dailyViewBtn.classList.remove('active');
                overviewViewBtn.classList.add('active');
                renderOverview();
            }
        }
        dailyViewBtn.onclick = () => switchView('daily');
        overviewViewBtn.onclick = () => switchView('overview');

        // 渲染每日视图条目
        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            container.innerHTML = '';
            memoData[days[currentDay]].forEach((entry, index) => {
                const row = document.createElement('div');
                row.className = 'entry-row';
                row.innerHTML = `
                    <input type="text" class="content-input" placeholder="内容" 
                           value="${entry.content}" data-index="${index}">
                    <input type="number" class="number-input" placeholder="数字" 
                           value="${entry.number}" data-index="${index}">
                    <button class="delete-btn" data-index="${index}">×</button>
                `;
                container.appendChild(row);
            });
            // 删除事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = () => {
                    const index = parseInt(btn.getAttribute('data-index'));
                    memoData[days[currentDay]].splice(index, 1);
                    renderEntries();
                };
            });
            // 输入事件
            document.querySelectorAll('.content-input, .number-input').forEach(input => {
                input.oninput = () => {
                    const index = parseInt(input.getAttribute('data-index'));
                    const field = input.classList.contains('content-input') ? 'content' : 'number';
                    memoData[days[currentDay]][index][field] = input.value;
                };
            });
        }

        // 渲染总览视图
        function renderOverview() {
            const container = document.getElementById('overviewGrid');
            container.innerHTML = '';
            let totalEntries = 0;
            let filledDays = 0;
            let highNumber = 0;
            // 计算统计
            days.forEach(day => {
                const entries = memoData[day].filter(e => e.content.trim() !== '' || e.number !== '');
                totalEntries += entries.length;
                if (entries.length > 0) filledDays++;
                entries.forEach(entry => {
                    const num = parseInt(entry.number);
                    if (!isNaN(num) && num > highNumber) highNumber = num;
                });
            });
            // 更新统计显示
            document.getElementById('totalEntries').textContent = totalEntries;
            document.getElementById('filledDays').textContent = filledDays;
            document.getElementById('highNumber').textContent = highNumber;
            // 创建每日卡片
            days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'overview-day';
                const dayEntries = memoData[day].filter(e => e.content.trim() !== '' || e.number !== '');
                dayCard.innerHTML = `
                    <div class="day-header">
                        <div class="day-title">${day}</div>
                        <button class="day-switch" data-day="${day}">查看</button>
                    </div>
                `;
                if (dayEntries.length > 0) {
                    dayEntries.forEach((entry, entryIndex) => {
                        const entryEl = document.createElement('div');
                        entryEl.className = 'overview-entry';
                        entryEl.innerHTML = `
                            <div class="overview-content">${entry.content || '未命名'}</div>
                            <div class="overview-number-control">
                                <button class="number-btn number-minus" data-day="${day}" data-index="${entryIndex}">-</button>
                                <span class="overview-number">${entry.number || '0'}</span>
                                <button class="number-btn number-plus" data-day="${day}" data-index="${entryIndex}">+</button>
                            </div>
                        `;
                        dayCard.appendChild(entryEl);
                    });
                } else {
                    dayCard.innerHTML += `<div class="no-entries">无记录</div>`;
                }
                container.appendChild(dayCard);
            });
            // 加减按钮事件
            document.querySelectorAll('.number-minus, .number-plus').forEach(btn => {
                btn.addEventListener('click', function () {
                    const day = this.getAttribute('data-day');
                    const index = parseInt(this.getAttribute('data-index'));
                    const currentValue = parseInt(memoData[day][index].number) || 0;
                    if (this.classList.contains('number-minus')) {
                        memoData[day][index].number = Math.max(0, currentValue - 1).toString();
                    } else {
                        memoData[day][index].number = (currentValue + 1).toString();
                    }
                    this.parentNode.querySelector('.overview-number').textContent = memoData[day][index].number;
                    renderOverviewStats();
                });
            });
            // 查看按钮事件
            document.querySelectorAll('.day-switch').forEach(btn => {
                btn.onclick = () => {
                    const day = btn.getAttribute('data-day');
                    const dayIndex = days.indexOf(day);
                    document.querySelectorAll('.day-btn').forEach((b, index) => {
                        if (index === dayIndex) {
                            b.classList.add('active');
                            currentDay = index;
                            document.getElementById('currentDate').textContent = days[currentDay];
                            renderEntries();
                        } else b.classList.remove('active');
                    });
                    switchView('daily');
                };
            });
        }

        // 更新总览统计
        function renderOverviewStats() {
            let totalEntries = 0;
            let filledDays = 0;
            let highNumber = 0;
            days.forEach(day => {
                const entries = memoData[day].filter(e => e.content.trim() !== '' || e.number !== '');
                totalEntries += entries.length;
                if (entries.length > 0) filledDays++;
                entries.forEach(entry => {
                    const num = parseInt(entry.number);
                    if (!isNaN(num) && num > highNumber) highNumber = num;
                });
            });
            document.getElementById('totalEntries').textContent = totalEntries;
            document.getElementById('filledDays').textContent = filledDays;
            document.getElementById('highNumber').textContent = highNumber;
        }

        // 添加新条目
        document.getElementById('addBtn').onclick = () => {
            memoData[days[currentDay]].push({ content: '', number: '' });
            renderEntries();
        };

        // 手动保存按钮
        document.getElementById('saveBtn').onclick = () => {
            saveToLocalStorage();
            alert('数据已保存！');
        };

        // 核心优化：上传按钮点击处理
        uploadBtn.onclick = async () => {
            // 检查是否已达到最大失败次数
            if (uploadFailureCount >= 3) {
                // 清除保存的令牌并提示重新输入
                localStorage.removeItem('githubToken');
                uploadFailureCount = 0;
                localStorage.setItem('uploadFailureCount', '0');
                alert('上传已连续失败3次，请重新输入GitHub令牌');
            }

            const token = localStorage.getItem('githubToken');
            const repo = localStorage.getItem('repoName');

            // 检查是否有成功记录且凭证存在
            if (hasSuccessfulRecord() && token && repo) {
                // 有成功记录，直接上传
                uploadBtn.textContent = '上传中...';
                uploadBtn.disabled = true;

                try {
                    await uploadToGitHub(token, repo);
                } finally {
                    uploadBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                        上传数据
                    `;
                    uploadBtn.disabled = false;
                }
            } else {
                // 无成功记录，打开配置模态框
                currentBackupOperation = 'upload';
                modalTitle.textContent = '上传数据到 GitHub';
                modalSubtitle.textContent = '首次使用，请配置您的 GitHub 信息';
                githubTokenInput.value = token || '';
                repoNameInput.value = repo || '';
                githubModal.style.display = 'flex';
            }
        };

        // 核心优化：下载按钮点击处理
        downloadBtn.onclick = async () => {
            const token = localStorage.getItem('githubToken');
            const repo = localStorage.getItem('repoName');

            // 检查是否有成功记录且凭证存在
            if (hasSuccessfulRecord() && token && repo) {
                // 有成功记录，直接下载
                downloadBtn.textContent = '下载中...';
                downloadBtn.disabled = true;

                try {
                    await downloadFromGitHub(token, repo);
                } finally {
                    downloadBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        下载数据
                    `;
                    downloadBtn.disabled = false;
                }
            } else {
                // 无成功记录，打开配置模态框
                currentBackupOperation = 'download';
                modalTitle.textContent = '从 GitHub 下载数据';
                modalSubtitle.textContent = '首次使用，请配置您的 GitHub 信息';
                githubTokenInput.value = token || '';
                repoNameInput.value = repo || '';
                githubModal.style.display = 'flex';
            }
        };

        // 关闭模态框
        function closeModal() {
            githubModal.style.display = 'none';
            currentBackupOperation = null;
        }
        closeModalBtn.onclick = closeModal;
        cancelBtn.onclick = closeModal;

        // 确认备份操作（首次配置或凭证变更时使用）
        confirmBtn.onclick = async () => {
            const token = githubTokenInput.value.trim();
            const repo = repoNameInput.value.trim();

            if (!token) {
                alert('请输入GitHub个人访问令牌');
                return;
            }
            if (!repo || !repo.includes('/')) {
                alert('请输入有效的仓库名称，格式为：用户名/仓库名');
                return;
            }

            // 保存GitHub凭证
            localStorage.setItem('githubToken', token);
            localStorage.setItem('repoName', repo);

            // 操作状态提示
            const originalBtnText = confirmBtn.textContent;
            confirmBtn.textContent = currentBackupOperation === 'upload' ? '上传中...' : '下载中...';
            confirmBtn.disabled = true;

            try {
                if (currentBackupOperation === 'upload') {
                    await uploadToGitHub(token, repo);
                } else if (currentBackupOperation === 'download') {
                    await downloadFromGitHub(token, repo);
                }
                // 首次操作成功，标记成功记录
                markSuccessfulRecord();
            } finally {
                confirmBtn.textContent = originalBtnText;
                confirmBtn.disabled = false;
                closeModal();
            }
        };

        // 上传数据到GitHub
        async function uploadToGitHub(token, repo) {
            try {
                // 上传前先同步保存本地数据
                saveToLocalStorage();

                const checkUrl = `https://api.github.com/repos/${repo}/contents/memo_data.json`;
                const checkResponse = await fetch(checkUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!checkResponse.ok && checkResponse.status !== 404) {
                    const errorData = await checkResponse.json();
                    throw new Error(`[${checkResponse.status}] ${errorData.message || '请求失败'}`);
                }

                let sha = null;
                // 核心优化：有成功记录时自动覆盖，无需确认
                if (checkResponse.ok) {
                    const fileData = await checkResponse.json();
                    sha = fileData.sha;
                }

                // 使用最新本地数据上传
                const content = JSON.stringify(memoData);
                const contentBase64 = Utf8Base64.encode(content);

                const uploadUrl = `https://api.github.com/repos/${repo}/contents/memo_data.json`;
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `备忘录数据备份（${new Date().toLocaleString()}）`,
                        content: contentBase64,
                        sha: sha
                    })
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(`[${uploadResponse.status}] ${errorData.message || '上传失败'}`);
                }

                // 上传成功后再次确认本地保存
                saveToLocalStorage();
                markSuccessfulRecord(); // 更新成功记录状态
                alert('数据上传成功！');
            } catch (error) {
                // 失败时增加计数器
                uploadFailureCount++;
                localStorage.setItem('uploadFailureCount', uploadFailureCount.toString());

                // 检查是否达到最大失败次数
                let errorMsg = `上传失败（${uploadFailureCount}/3）：`;
                if (error.message.includes('401')) errorMsg += 'GitHub令牌无效或权限不足，请检查令牌是否包含repo权限';
                else if (error.message.includes('404')) errorMsg += '仓库不存在或您无访问权限，请确认仓库名称格式（用户名/仓库名）';
                else if (error.message.includes('Base64')) errorMsg += '数据编码失败，内容包含异常字符';
                else errorMsg += error.message;

                // 如果达到最大失败次数，提示重新输入
                if (uploadFailureCount >= 3) {
                    errorMsg += '\n已连续失败3次，请重新输入GitHub令牌';
                    localStorage.removeItem('githubToken');
                }

                alert(errorMsg);
                console.error('上传错误详情：', error);
            }
        }

        // 从GitHub下载数据
        async function downloadFromGitHub(token, repo) {
            try {
                // 核心优化：有成功记录时简化提示，保留必要的安全确认
                const confirmProceed = confirm('确定要从GitHub下载数据吗？这将覆盖当前本地数据。');
                if (!confirmProceed) return;

                // 自动备份本地数据（无需用户额外确认）
                localStorage.setItem(`memoData_backup_${new Date().getTime()}`, JSON.stringify(memoData));

                const url = `https://api.github.com/repos/${repo}/contents/memo_data.json`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`[${response.status}] ${errorData.message || '文件不存在或无法访问'}`);
                }

                const fileData = await response.json();
                const contentBase64 = fileData.content;
                const content = Utf8Base64.decode(contentBase64);
                const newData = JSON.parse(content);

                if (!newData || typeof newData !== 'object' || !Object.keys(newData).length) {
                    throw new Error('备份文件数据为空或格式错误');
                }

                // 下载后更新本地数据
                memoData = newData;
                saveToLocalStorage();
                renderEntries();
                if (overviewView.style.display !== 'none') renderOverview();

                markSuccessfulRecord(); // 更新成功记录状态
                alert('数据下载成功！本地数据已更新');
            } catch (error) {
                let errorMsg = '下载失败：';
                if (error.message.includes('401')) errorMsg += 'GitHub令牌无效或权限不足';
                else if (error.message.includes('404')) errorMsg += '备份文件不存在';
                else if (error.message.includes('JSON')) errorMsg += '文件解析失败，可能是损坏的JSON';
                else if (error.message.includes('Base64')) errorMsg += '文件解码失败，格式异常';
                else errorMsg += error.message;

                alert(errorMsg);
                console.error('下载错误详情：', error);
            }
        }

        // 初始化页面
        document.getElementById('currentDate').textContent = days[currentDay];
        renderEntries();
    </script>
</body>

</html>