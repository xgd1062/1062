<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookmark Pro - å®‰å…¨å¢å¼ºç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --primary-blue: #3b82f6; }
    
    /* å¡ç‰‡åŸºç¡€æ ·å¼ */
    .bookmark-card { 
      transition: all .2s ease; 
      cursor: pointer; 
      position: relative; 
      padding: 1rem; 
      border-radius: 0.75rem; 
      background: white; 
      border: 1px solid #eee; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04); 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      gap: 0.5rem; 
      /* å…³é”®ï¼šé˜²æ­¢ flex å­é¡¹æº¢å‡º */
      min-width: 0; 
    }
    .bookmark-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08); 
      border-color: var(--primary-blue); 
    }
    
    /* å¤´éƒ¨å¸ƒå±€ */
    .card-header { 
      display: flex; 
      align-items: center; 
      gap: 0.75rem; 
      width: 100%; 
    }
    .favicon-container { 
      width: 20px; 
      height: 20px; 
      flex-shrink: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .bookmark-title { 
      font-size: 1rem; 
      font-weight: 600; 
      color: #111827; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      flex-grow: 1; 
      /* å…³é”®ï¼šé…åˆ min-width:0 å®ç°æˆªæ–­ */
      min-width: 0;
    }
    
    /* å¸ƒå±€ä¸å¯¼èˆª */
    header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: white; border-bottom: 1px solid #eee; }
    .category-tabs-container { 
      position: sticky; top: 72px; z-index: 40; background: #f9fafb; 
      padding: 0.75rem 1rem; margin: 74px auto 1rem; max-width: 1200px; 
      border-radius: 0.75rem; display: flex; align-items: center; gap: 0.5rem; 
      overflow-x: auto; scrollbar-width: none; 
    }
    .category-tabs-container::-webkit-scrollbar { display: none; }
    
    /* æ¨¡æ€æ¡† */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .modal.show { opacity: 1; visibility: visible; }
    
    /* æŒ‰é’®ç»„ */
    .action-btn { opacity: 0; transition: opacity 0.2s; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .action-btn:hover { background-color: #f3f4f6; }
    .bookmark-card:hover .action-btn { opacity: 1; }

    /* åˆ†ç±»æ ‡ç­¾æ ·å¼ */
    .cat-btn { display: flex; align-items: center; gap: 6px; padding-right: 8px; transition: all 0.2s; }
    .cat-delete-btn { 
      width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
      font-size: 10px; line-height: 1; opacity: 0.6; cursor: pointer;
    }
    .cat-delete-btn:hover { background-color: rgba(0,0,0,0.2); opacity: 1; color: white; }
    
    /* é€‰ä¸­çŠ¶æ€ä¸‹çš„åˆ é™¤æŒ‰é’®æ›´æ˜æ˜¾ */
    .cat-btn.active .cat-delete-btn:hover { background-color: rgba(255,255,255,0.3); }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <header>
    <div class="max-w-[1200px] mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-2 select-none">
        <span class="text-2xl">ğŸ›¡ï¸</span>
        <h1 class="text-xl font-bold tracking-tight">Bookmark Pro</h1>
      </div>
      <div class="flex-1 max-w-md">
        <input type="text" id="search-input" placeholder="æœç´¢ä¹¦ç­¾ (å…¨å±€)..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500/20 outline-none transition-shadow">
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="import-btn" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">å¯¼å…¥</button>
        <button id="export-btn" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">å¯¼å‡º</button>
        
        <button id="deduplicate-btn" class="px-3 py-2 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg hover:bg-yellow-100 transition-colors">å»é‡</button>
        <button id="sync-github-btn" class="px-3 py-2 bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">åŒæ­¥ GitHub</button>
        <button id="push-github-btn" class="px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">ä¸Šä¼  GitHub</button>
        <button id="add-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold transition-colors shadow-sm">æ·»åŠ ä¹¦ç­¾</button>
      </div>
    </div>
  </header>

  <div class="category-tabs-container" id="category-tabs-container">
    <div id="tabs-list" class="flex gap-2"></div>
    <button id="open-cat-modal" class="ml-auto text-sm font-bold text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-50 whitespace-nowrap">+ åˆ†ç±»</button>
  </div>

  <main class="max-w-[1200px] mx-auto px-4 pb-12">
    <div id="bookmarks-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
    <div id="empty-state" class="hidden text-center py-20 text-gray-400">
      <p>æš‚æ— ä¹¦ç­¾ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æˆ–å¯¼å…¥</p>
    </div>
  </main>

  <div id="bookmark-modal" class="modal" onclick="if(event.target==this) closeModal('bookmark-modal')">
    <div class="bg-white p-6 rounded-xl w-[90%] max-w-md shadow-2xl transform transition-all">
      <h3 id="modal-title" class="text-lg font-bold mb-4">ä¹¦ç­¾ä¿¡æ¯</h3>
      <input type="hidden" id="edit-id">
      <div class="space-y-3">
        <div>
          <label class="block text-xs text-gray-500 mb-1 ml-1">æ ‡é¢˜</label>
          <input type="text" id="bookmark-name" class="w-full border p-2.5 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚: Google">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1 ml-1">ç½‘å€</label>
          <input type="text" id="bookmark-url" class="w-full border p-2.5 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="https://...">
        </div>
        <div>
           <label class="block text-xs text-gray-500 mb-1 ml-1">åˆ†ç±»</label>
           <select id="bookmark-category" class="w-full border p-2.5 rounded-lg outline-none bg-white"></select>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button onclick="closeModal('bookmark-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50 text-sm">å–æ¶ˆ</button>
        <button id="save-bookmark" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm shadow-sm">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="cat-modal" class="modal" onclick="if(event.target==this) closeModal('cat-modal')">
    <div class="bg-white p-6 rounded-xl w-[90%] max-w-xs shadow-2xl">
      <h3 class="text-lg font-bold mb-4">æ–°å¢åˆ†ç±»</h3>
      <input type="text" id="new-cat-name" class="w-full border p-2.5 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-center" placeholder="åˆ†ç±»åç§°">
      <div class="flex justify-end gap-2 mt-6">
        <button onclick="closeModal('cat-modal')" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
        <button id="save-new-cat" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="github-modal" class="modal" onclick="if(event.target==this) closeModal('github-modal')">
    <div class="bg-white p-6 rounded-xl w-[90%] max-w-md shadow-2xl">
      <h3 class="text-lg font-bold mb-4 border-b pb-2">GitHub åŒæ­¥è®¾ç½®</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1 ml-1 font-semibold uppercase">Token (ä»¤ç‰Œ)</label>
          <input type="password" id="gh-token" class="w-full border p-2.5 rounded-lg focus:border-blue-500 outline-none" placeholder="ghp_xxxxxxxxxxxx">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1 ml-1 font-semibold uppercase">å®Œæ•´æ–‡ä»¶åœ°å€</label>
          <input type="text" id="gh-full-path" class="w-full border p-2.5 rounded-lg focus:border-blue-500 outline-none" value="xgd1062/1062/000/11ä¹¦ç­¾.json">
          <p class="text-[10px] text-gray-400 mt-1 leading-relaxed">åœ°å€æ ¼å¼: ç”¨æˆ·å/ä»“åº“å/æ–‡ä»¶å¤¹/æ–‡ä»¶å.json</p>
        </div>
      </div>
      <p id="gh-error-hint" class="text-red-500 text-xs mt-3 hidden"></p>
      <div class="flex justify-end gap-2 mt-6">
        <button onclick="closeModal('github-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50 text-sm">å–æ¶ˆ</button>
        <button id="save-github-config" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm shadow-sm">ä¿å­˜é…ç½®</button>
      </div>
    </div>
  </div>
  <input type="file" id="file-selector" accept=".html" class="hidden">

  <script>
    // --- 1. æ•°æ®åˆå§‹åŒ–ä¸è¿ç§» ---
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
    let customCats = JSON.parse(localStorage.getItem('custom_categories')) || {};

    // ç¡®ä¿æœ‰ "æœªåˆ†ç±»"ï¼Œå¹¶ä¿®å¤å†å²æ•°æ®
    if (!customCats.uncategorized) {
      customCats = { uncategorized: 'æœªåˆ†ç±»', ...customCats };
      localStorage.setItem('custom_categories', JSON.stringify(customCats));
    }

    let currentCategory = 'all';
    let searchQuery = '';

    // --- 2. æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ (DOMæ“ä½œä»£æ›¿innerHTML) ---
    function renderBookmarks() {
      const grid = document.getElementById('bookmarks-grid');
      const emptyState = document.getElementById('empty-state');
      grid.innerHTML = '';
      
      const isSearchActive = searchQuery.length > 0;

      // è¿‡æ»¤é€»è¾‘ï¼šå¦‚æœæœ‰æœç´¢è¯ï¼Œå¿½ç•¥åˆ†ç±»é™åˆ¶ï¼›å¦åˆ™éµå®ˆåˆ†ç±»
      const filtered = bookmarks.filter(b => {
        const matchesSearch = b.name.toLowerCase().includes(searchQuery) || b.url.toLowerCase().includes(searchQuery);
        const matchesCat = currentCategory === 'all' || b.category === currentCategory;
        return isSearchActive ? matchesSearch : (matchesCat && matchesSearch);
      });

      if (filtered.length === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }

      // é»˜è®¤ SVG å›¾æ ‡ (ç°è‰²åœ°çƒ)ï¼Œç”¨äºåŠ è½½å¤±è´¥æ—¶
      const defaultIcon = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9'/%3E%3C/svg%3E`;

      filtered.forEach(b => {
        // ä½¿ç”¨ document.createElement é˜²æ­¢ XSS
        const card = document.createElement('div');
        card.className = 'bookmark-card';
        
        // ç‚¹å‡»æ‰“å¼€é“¾æ¥
        card.addEventListener('click', () => {
             try {
                 const validUrl = new URL(b.url);
                 window.open(validUrl.href, '_blank');
             } catch(e) { alert('URL æ— æ•ˆ'); }
        });

        // è·å– hostname å°è¯•åŠ è½½å›¾æ ‡
        let hostname = 'unknown';
        try { hostname = new URL(b.url).hostname; } catch(e) {}

        // --- æ„å»º Header ---
        const header = document.createElement('div');
        header.className = 'card-header';

        const favContainer = document.createElement('div');
        favContainer.className = 'favicon-container';
        const img = document.createElement('img');
        img.width = 16; img.height = 16;
        img.src = `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`;
        img.onerror = () => { img.src = defaultIcon; };
        favContainer.appendChild(img);

        const title = document.createElement('h3');
        title.className = 'bookmark-title';
        title.textContent = b.name; // å®‰å…¨èµ‹å€¼

        const btnGroup = document.createElement('div');
        btnGroup.className = 'flex gap-1 items-center ml-auto'; // ml-auto ç¡®ä¿æŒ‰é’®é å³

        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn text-gray-400 hover:text-blue-600';
        editBtn.textContent = 'âœ';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditModal(b.id); };

        const delBtn = document.createElement('button');
        delBtn.className = 'action-btn text-gray-400 hover:text-red-500';
        delBtn.textContent = 'âœ•'; // ä½¿ç”¨ unicode x
        delBtn.onclick = (e) => { e.stopPropagation(); deleteBookmark(b.id); };

        btnGroup.append(editBtn, delBtn);
        header.append(favContainer, title, btnGroup);

        // --- æ„å»º URL æ–‡æœ¬ ---
        const urlText = document.createElement('p');
        urlText.className = 'text-xs text-gray-400 truncate w-full';
        urlText.textContent = b.url; // å®‰å…¨èµ‹å€¼

        card.append(header, urlText);
        grid.appendChild(card);
      });
    }

    function renderCats() {
      const list = document.getElementById('tabs-list');
      list.innerHTML = '';

      // æ¸²æŸ“ "å…¨éƒ¨"
      const allBtn = createCatButton('all', 'å…¨éƒ¨', false);
      list.appendChild(allBtn);

      // æ¸²æŸ“å…¶ä½™åˆ†ç±»
      Object.entries(customCats).forEach(([key, name]) => {
        const canDelete = key !== 'uncategorized'; // æœªåˆ†ç±»ä¸å¯åˆ é™¤
        list.appendChild(createCatButton(key, name, canDelete));
      });
    }

    function createCatButton(key, name, canDelete) {
      const btn = document.createElement('div'); // å¤–å±‚ç”¨ div æ–¹ä¾¿å¸ƒå±€
      const isActive = currentCategory === key;
      btn.className = `cat-btn px-4 py-2 rounded-full text-sm cursor-pointer select-none ${isActive ? 'bg-blue-600 text-white active' : 'bg-gray-200 hover:bg-gray-300 text-gray-700'}`;
      
      const span = document.createElement('span');
      span.textContent = name;
      span.onclick = () => setCategory(key);
      btn.appendChild(span);

      if (canDelete) {
        const del = document.createElement('span');
        del.className = 'cat-delete-btn';
        del.textContent = 'âœ•';
        del.onclick = (e) => {
          e.stopPropagation();
          confirmDeleteCat(key);
        };
        btn.appendChild(del);
      } else {
        // ä¸ºäº†ä¿æŒæ–‡å­—å±…ä¸­è§†è§‰å¹³è¡¡ï¼Œå¯ä»¥ç”¨ paddingï¼Œè¿™é‡Œç®€å•å¤„ç†ç‚¹å‡»äº‹ä»¶
        btn.onclick = () => setCategory(key);
      }
      return btn;
    }

    // --- 3. å¥å£®çš„å¯¼å…¥é€»è¾‘ (é€’å½’) ---
    document.getElementById('import-btn').onclick = () => document.getElementById('file-selector').click();
    document.getElementById('file-selector').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(event.target.result, 'text/html');
        
        // é€’å½’éå† DOM æ ‘
        function traverse(element, catId) {
            const children = Array.from(element.children);
            children.forEach(node => {
                // Netscape æ ¼å¼é€šå¸¸æ˜¯: DT -> H3 (Folder Name) + DL (Folder Content)
                // æœ‰äº›æµè§ˆå™¨å¯¼å‡ºæ˜¯ DT -> H3, ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹æ˜¯ DL
                
                if (node.tagName === 'DT') {
                    const h3 = node.querySelector('h3');
                    const dl = node.querySelector('dl');
                    const a = node.querySelector('a');

                    if (h3) {
                        // å‘ç°æ–‡ä»¶å¤¹
                        const folderName = h3.textContent.trim();
                        let newCatId = Object.keys(customCats).find(k => customCats[k] === folderName);
                        if (!newCatId) {
                            newCatId = generateId('cat_');
                            customCats[newCatId] = folderName;
                        }
                        
                        // å¯»æ‰¾å†…å®¹ï¼šå¯èƒ½æ˜¯å­ DLï¼Œæˆ–è€…æ˜¯ä¸‹ä¸€ä¸ªå…„å¼Ÿ DL
                        if (dl) {
                            traverse(dl, newCatId);
                        } else {
                             // å°è¯•æŸ¥æ‰¾å…„å¼ŸèŠ‚ç‚¹ (Chrome æ ¼å¼æœ‰æ—¶å¦‚æ­¤)
                             let nextSibling = node.nextElementSibling;
                             if(nextSibling && nextSibling.tagName === 'DD') {
                                 let innerDL = nextSibling.querySelector('dl');
                                 if(innerDL) traverse(innerDL, newCatId);
                             }
                        }
                    } else if (a) {
                        // å‘ç°ä¹¦ç­¾
                        bookmarks.push({
                            id: generateId('id_'),
                            name: a.textContent.trim(),
                            url: a.href,
                            category: catId
                        });
                    }
                } else if (node.tagName === 'DL') {
                    // ç›´æ¥åµŒå¥—çš„ DL
                    traverse(node, catId);
                }
            });
        }

        // å°è¯•æ‰¾åˆ°æ ¹ DL
        const rootDL = doc.querySelector('dl');
        if (rootDL) {
            traverse(rootDL, 'uncategorized');
            saveData();
            alert(`å¯¼å…¥æˆåŠŸï¼å…± ${bookmarks.length} ä¸ªä¹¦ç­¾ã€‚`);
            location.reload();
        } else {
            alert('æ— æ³•è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ç¡®ä¿æ˜¯æµè§ˆå™¨å¯¼å‡ºçš„ HTML ä¹¦ç­¾æ–‡ä»¶ã€‚');
        }
      };
      reader.readAsText(file);
      e.target.value = ''; // é‡ç½® input
    };

    // --- 4. å¯¼å‡ºé€»è¾‘ ---
    document.getElementById('export-btn').onclick = () => {
      let html = `<!DOCTYPE NETSCAPE-Bookmark-file-1>\n\n<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">\n<TITLE>Bookmarks</TITLE>\n<H1>Bookmarks</H1>\n<DL><p>\n`;
      
      // å…ˆå¤„ç†æœªåˆ†ç±»
      const uncategorized = bookmarks.filter(b => b.category === 'uncategorized');
      uncategorized.forEach(b => {
          html += `    <DT><A HREF="${b.url}">${b.name}</A>\n`;
      });

      // å¤„ç†å…¶ä»–åˆ†ç±»
      Object.entries(customCats).forEach(([key, name]) => {
        if (key === 'uncategorized') return;
        const catBks = bookmarks.filter(b => b.category === key);
        if (catBks.length > 0) {
            html += `    <DT><H3>${name}</H3>\n    <DL><p>\n`;
            catBks.forEach(b => {
                html += `        <DT><A HREF="${b.url}">${b.name}</A>\n`;
            });
            html += `    </DL><p>\n`;
        }
      });
      
      html += `</DL><p>`;
      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bookmarks_${new Date().toISOString().slice(0,10)}.html`;
      a.click();
    };

    // --- 5. è¾…åŠ©åŠŸèƒ½ä¸äº‹ä»¶ ---
    function generateId(prefix) {
        if (window.crypto && window.crypto.randomUUID) {
            return prefix + window.crypto.randomUUID();
        }
        return prefix + Date.now() + Math.random().toString(36).substring(2);
    }

    function setCategory(cat) { 
        currentCategory = cat; 
        renderCats(); 
        renderBookmarks(); 
    }
    
    function saveData() {
        localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        localStorage.setItem('custom_categories', JSON.stringify(customCats));
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    // ä¿å­˜ä¹¦ç­¾ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
    document.getElementById('save-bookmark').onclick = () => {
      const nameInput = document.getElementById('bookmark-name');
      const urlInput = document.getElementById('bookmark-url');
      const catInput = document.getElementById('bookmark-category');
      const editId = document.getElementById('edit-id').value;

      const name = nameInput.value.trim();
      let url = urlInput.value.trim();
      const cat = catInput.value;

      if (!name || !url) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }

      // URL è‡ªåŠ¨è¡¥å…¨ä¸éªŒè¯
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
      try { new URL(url); } catch(e) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€'); return; }

      if (editId) {
        const b = bookmarks.find(i => i.id === editId);
        if (b) { Object.assign(b, { name, url, category: cat }); }
      } else {
        bookmarks.push({ id: generateId('id_'), name, url, category: cat });
      }
      
      saveData();
      renderBookmarks();
      closeModal('bookmark-modal');
    };

    document.getElementById('add-btn').onclick = () => {
      document.getElementById('modal-title').textContent = 'æ–°å¢ä¹¦ç­¾';
      document.getElementById('edit-id').value = '';
      document.getElementById('bookmark-name').value = '';
      document.getElementById('bookmark-url').value = '';
      
      const sel = document.getElementById('bookmark-category');
      const targetCat = (currentCategory === 'all') ? 'uncategorized' : currentCategory;
      
      sel.innerHTML = Object.entries(customCats)
        .map(([k,v]) => `<option value="${k}" ${k === targetCat ? 'selected' : ''}>${v}</option>`)
        .join('');
        
      document.getElementById('bookmark-modal').classList.add('show');
      setTimeout(() => document.getElementById('bookmark-name').focus(), 100);
    };

    // æ–°å¢åˆ†ç±»
    document.getElementById('open-cat-modal').onclick = () => {
      document.getElementById('new-cat-name').value = '';
      document.getElementById('cat-modal').classList.add('show');
      setTimeout(() => document.getElementById('new-cat-name').focus(), 100);
    };

    document.getElementById('save-new-cat').onclick = () => {
      const n = document.getElementById('new-cat-name').value.trim();
      if(!n) return;
      if (Object.values(customCats).includes(n)) { alert('åˆ†ç±»åå·²å­˜åœ¨'); return; }
      
      const newId = generateId('cat_');
      customCats[newId] = n;
      saveData();
      
      // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°åˆ†ç±»
      setCategory(newId);
      closeModal('cat-modal');
    };

    function openEditModal(id) {
      const b = bookmarks.find(i => i.id === id);
      if (!b) return;
      document.getElementById('modal-title').textContent = 'ç¼–è¾‘ä¹¦ç­¾';
      document.getElementById('edit-id').value = id;
      document.getElementById('bookmark-name').value = b.name;
      document.getElementById('bookmark-url').value = b.url;
      
      const sel = document.getElementById('bookmark-category');
      sel.innerHTML = Object.entries(customCats)
        .map(([k,v]) => `<option value="${k}" ${k===b.category?'selected':''}>${v}</option>`)
        .join('');
        
      document.getElementById('bookmark-modal').classList.add('show');
    }

    function deleteBookmark(id) {
      if(confirm('ç¡®å®šåˆ é™¤æ­¤ä¹¦ç­¾å—ï¼Ÿ')) { 
          bookmarks = bookmarks.filter(i => i.id !== id); 
          saveData(); 
          renderBookmarks(); 
      }
    }

    function confirmDeleteCat(key) {
      const count = bookmarks.filter(b => b.category === key).length;
      const msg = count > 0 
        ? `åˆ é™¤åˆ†ç±» "${customCats[key]}"ï¼Ÿ\nè¯¥åˆ†ç±»ä¸‹çš„ ${count} ä¸ªä¹¦ç­¾å°†ç§»è‡³ "æœªåˆ†ç±»"ã€‚` 
        : `åˆ é™¤åˆ†ç±» "${customCats[key]}"ï¼Ÿ`;
        
      if(confirm(msg)) {
        bookmarks.forEach(b => { if(b.category === key) b.category = 'uncategorized'; });
        delete customCats[key];
        saveData();
        setCategory('all');
      }
    }

    // æœç´¢ä¸å›è½¦äº‹ä»¶
    document.getElementById('search-input').oninput = (e) => { 
        searchQuery = e.target.value.toLowerCase(); 
        renderBookmarks(); 
    };
    
    function bindEnter(inputId, btnId) {
        document.getElementById(inputId).addEventListener('keydown', (e) => {
            if(e.key === 'Enter') document.getElementById(btnId).click();
        });
    }
    bindEnter('bookmark-name', 'save-bookmark');
    bindEnter('bookmark-url', 'save-bookmark');
    bindEnter('new-cat-name', 'save-new-cat');

    // --- æ–°å¢åŠŸèƒ½é€»è¾‘åŒºå¼€å§‹ ---

    let ghConfig = JSON.parse(localStorage.getItem('gh_config')) || null;
    let ghFailCount = 0;

    // 1. å»é‡é€»è¾‘
    document.getElementById('deduplicate-btn').onclick = () => {
      const originalCount = bookmarks.length;
      const seen = new Set();
      bookmarks = bookmarks.filter(b => {
        const norm = b.url.replace(/\/$/, "").toLowerCase();
        if (seen.has(norm)) return false;
        seen.add(norm); return true;
      });
      if (originalCount > bookmarks.length) {
        saveData(); renderBookmarks(); alert(`æ¸…ç†å®Œæˆï¼Œå·²ç§»é™¤ ${originalCount - bookmarks.length} ä¸ªé‡å¤é¡¹`);
      } else alert("æœªå‘ç°é‡å¤é¡¹");
    };

    // 2. è§£æ GitHub åœ°å€
    const parseGhPath = () => {
      const full = document.getElementById('gh-full-path').value.trim();
      const parts = full.split('/');
      if (parts.length < 3) return null;
      return { repo: `${parts[0]}/${parts[1]}`, path: parts.slice(2).join('/') };
    };

    // 3. é€šç”¨ GitHub è¯·æ±‚å‡½æ•°
    async function ghRequest(url, options = {}) {
      if (!ghConfig) { document.getElementById('github-modal').classList.add('show'); return null; }
      if (ghFailCount >= 3) {
        document.getElementById('gh-error-hint').textContent = "å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¡®è®¤é…ç½®ã€‚";
        document.getElementById('gh-error-hint').classList.remove('hidden');
        document.getElementById('github-modal').classList.add('show');
        return null;
      }
      options.headers = { ...options.headers, 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' };
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(res.status);
        return res;
      } catch (e) {
        ghFailCount++;
        alert(`GitHub è¯·æ±‚å¤±è´¥ (${ghFailCount}/3)`);
        if (ghFailCount >= 3) document.getElementById('github-modal').classList.add('show');
        return null;
      }
    }

    // 4. åŒæ­¥ GitHub
    document.getElementById('sync-github-btn').onclick = async () => {
      if (!ghConfig) { document.getElementById('github-modal').classList.add('show'); return; }
      const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
      const res = await ghRequest(url);
      if (!res) return;
      const data = await res.json();
      const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
      if (confirm("è·å–æˆåŠŸï¼Œæ˜¯å¦è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®ï¼Ÿ")) {
        bookmarks = content.bookmarks; customCats = content.categories;
        saveData(); location.reload();
      }
    };

    // 5. ä¸Šä¼  GitHub
    document.getElementById('push-github-btn').onclick = async () => {
      if (!ghConfig) { document.getElementById('github-modal').classList.add('show'); return; }
      const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
      const existing = await ghRequest(url);
      let sha = "";
      if (existing) { const d = await existing.json(); sha = d.sha; }
      const payload = { bookmarks, categories: customCats };
      const body = {
        message: "sync via Bookmark Pro",
        content: btoa(unescape(encodeURIComponent(JSON.stringify(payload)))),
        sha: sha || undefined
      };
      const res = await ghRequest(url, { method: 'PUT', body: JSON.stringify(body) });
      if (res) alert("æ¨é€æˆåŠŸ"), ghFailCount = 0;
    };

    // 6. ä¿å­˜é…ç½®
    document.getElementById('save-github-config').onclick = () => {
      const token = document.getElementById('gh-token').value.trim();
      const parsed = parseGhPath();
      if (!token || !parsed) return alert("é…ç½®ä¸å®Œæ•´æˆ–æ ¼å¼é”™è¯¯");
      ghConfig = { token, ...parsed };
      localStorage.setItem('gh_config', JSON.stringify(ghConfig));
      ghFailCount = 0;
      closeModal('github-modal');
    };

    // --- æ–°å¢åŠŸèƒ½é€»è¾‘åŒºç»“æŸ ---

    // åˆå§‹åŒ–æ¸²æŸ“
    renderCats();
    renderBookmarks();
  </script>
</body>
</html>