<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿæ”¯å‡ºè®°è´¦æœ¬ - å½“æ—¥æ±‡æ€»ç‰ˆ (å¸¦å†å²è®°å½•)</title>
    <style>
        :root {
            --primary-color: #3f51b5;
            /* Indigo */
            --secondary-color: #f44336;
            /* Red (Expense) */
            --danger-color: #dc3545;
            /* Darker Red for delete button */
            --bg-light: #f7f9fc;
            --card-bg: #ffffff;
            --text-color: #333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        body {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            background-color: var(--bg-light);
            color: var(--text-color);
        }

        /* Header */
        header {
            text-align: center;
            padding: 15px 0 20px;
            border-bottom: 2px solid #eee;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        #current-datetime {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Daily Summary Box (Moved to bottom) */
        #daily-summary {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 20px;
            margin-top: 30px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        #daily-summary h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            opacity: 0.8;
        }

        #daily-total {
            font-size: 2.2em;
            font-weight: bold;
        }


        /* Input Form */
        .input-card {
            background-color: var(--card-bg);
            padding: 20px;
            margin-top: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        #quick-entry-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
            resize: none;
            transition: border-color 0.3s;
        }

        #quick-entry-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #submit-btn {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #submit-btn:hover {
            background-color: #303f9f;
        }

        /* Preview */
        #preview-box {
            margin-top: 15px;
            padding: 10px;
            background-color: #ffebee;
            /* Light red background for preview */
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.5;
            color: var(--secondary-color);
            min-height: 40px;
        }

        #preview-box strong {
            color: var(--secondary-color);
        }

        /* History List */
        .history-section {
            margin-top: 30px;
        }
        
        /* è°ƒæ•´æ ‡é¢˜ä¸æŒ‰é’®çš„å¸ƒå±€ */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .history-section h2 {
            font-size: 1.4em;
            color: var(--text-color);
            margin: 0;
        }
        
        #view-history-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        #view-history-btn:hover {
            background-color: #303f9f;
        }


        #entries-list {
            list-style: none;
            padding: 0;
        }

        .entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: var(--card-bg);
            border-left: 5px solid var(--secondary-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .entry-description {
            flex-grow: 1;
        }

        .entry-description .desc-text {
            font-weight: 500;
        }

        .entry-description .desc-time {
            display: block;
            font-size: 0.8em;
            color: #999;
        }

        .entry-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
            justify-content: flex-end;
        }

        .entry-amount {
            font-weight: bold;
            font-size: 1.1em;
            text-align: right;
            color: var(--secondary-color);
            flex-shrink: 0;
        }

        .delete-entry-btn {
            background: none;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
        }

        .delete-entry-btn:hover {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Modal/Dialog Styles for History */
        #history-modal {
            padding: 0;
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            background-color: var(--bg-light);
        }

        #history-modal::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* é™åˆ¶å†…å®¹é«˜åº¦ */
        }
        
        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.5em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        #history-list {
            list-style: none;
            padding: 0;
            overflow-y: auto; /* å†å²åˆ—è¡¨å¯æ»šåŠ¨ */
            flex-grow: 1;
            margin-bottom: 15px;
        }
        
        #history-list .entry-item {
            border-left-color: #6c757d; /* å†å²è®°å½•ç”¨ä¸åŒçš„é¢œè‰² */
        }
        
        .history-close-btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }
        
        .history-close-btn:hover {
            background-color: var(--danger-color);
        }
    </style>
</head>

<body>

    <header>
        <h1>ğŸ’¸ å¿«é€Ÿæ”¯å‡ºè®°è´¦</h1>
        <div id="current-datetime"></div>
    </header>

    <div class="input-card">
        <h2>è¾“å…¥ (æè¿° + é‡‘é¢)</h2>
        <form id="accounting-form">
            <input type="text" id="quick-entry-input" placeholder="ä¾‹å¦‚: ä¹°äº†å’–å•¡ 15" required autocomplete="off">

            <div id="preview-box">è¾“å…¥å†…å®¹åè‡ªåŠ¨è¯†åˆ«...</div>

            <button type="submit" id="submit-btn">è®°å½•å¹¶ä¿å­˜</button>
        </form>
    </div>

    <div class="history-section">
        <div class="history-header">
            <h2>ä»Šæ—¥è®°è´¦å†å²</h2>
            <button id="view-history-btn">æŸ¥çœ‹å†å²è®°å½•</button>
        </div>
        <ul id="entries-list">
            </ul>
    </div>
    
    <div id="daily-summary">
        <h3>ä»Šæ—¥æ€»æ”¯å‡º</h3>
        <div id="daily-total">ï¿¥0.00</div>
    </div>
    
    <dialog id="history-modal">
        <div class="modal-content">
            <h3>ğŸ“– å½’æ¡£å†å²è®°å½•</h3>
            <ul id="history-list">
                </ul>
            <button class="history-close-btn" onclick="closeHistoryModal()">å…³é—­</button>
        </div>
    </dialog>


    <script>
        const STORAGE_KEY = 'quickAccountingCurrentDayEntries';
        const HISTORY_STORAGE_KEY = 'quickAccountingArchivedHistory'; 
        
        const inputElement = document.getElementById('quick-entry-input');
        const formElement = document.getElementById('accounting-form');
        const entriesList = document.getElementById('entries-list');
        const dateTimeElement = document.getElementById('current-datetime');
        const previewBox = document.getElementById('preview-box');
        const dailyTotalElement = document.getElementById('daily-total');
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const historyModal = document.getElementById('history-modal');
        const historyListElement = document.getElementById('history-list'); // æ–°å¢å†å²åˆ—è¡¨DOM

        let entries = []; // ä»…å­˜å‚¨ä»Šæ—¥è®°å½•
        let historyEntries = []; // å­˜å‚¨æ‰€æœ‰å½’æ¡£çš„å†å²è®°å½•

        /**
         * 1. æ—¶é—´å¤„ç†å‡½æ•°
         */
        function getTodayDateStr() {
            return new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = getTodayDateStr();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            dateTimeElement.textContent = `å½“å‰æ—¶é—´: ${dateStr} ${timeStr}`;
            
            const summaryHeader = document.querySelector('#daily-summary h3');
            if (summaryHeader) {
                summaryHeader.textContent = `ä»Šæ—¥æ€»æ”¯å‡ºï¼ˆ${dateStr}ï¼‰`;
            }
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        /**
         * 2. æ ¸å¿ƒï¼šè§£æè¾“å…¥å†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«é‡‘é¢å’Œæè¿°
         */
        function parseInput(input) {
            const text = input.trim();
            const amountRegex = /(\d+(\.\d{1,2})?)/;
            const match = text.match(amountRegex);
            let amount = 0;
            let description = text;

            if (match) {
                const amountStr = match[1]; 
                amount = parseFloat(amountStr);
                description = text.replace(match[0], '').trim();
            }
            
            if (description === "") {
                 const tempDesc = text.replace(match ? match[0] : '', '').trim();
                 description = tempDesc || 'æœªå‘½åè®°å½•';
            }

            if (amount > 0) {
                amount = -amount;
            } else if (amount === 0) {
                 if (text !== '') {
                    description = text;
                 }
            }

            return {
                amount: amount,
                description: description
            };
        }

        /**
         * 3. æ•°æ®å­˜å‚¨å’ŒåŠ è½½ - ã€æ—¥ç»ˆæ•´ç†é€»è¾‘åœ¨æ­¤ã€‘
         */
        function loadEntries() {
            const todayDateStr = getTodayDateStr();
            
            // 1. åŠ è½½å†å²è®°å½•
            const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
            if (storedHistory) {
                historyEntries = JSON.parse(storedHistory);
            }

            // 2. åŠ è½½å½“å‰ï¼ˆå½“æ—¥ï¼‰è®°å½•
            const storedCurrent = localStorage.getItem(STORAGE_KEY);
            let loadedEntries = storedCurrent ? JSON.parse(storedCurrent) : [];
            
            let entriesToArchive = [];
            let currentDayEntries = [];

            // 3. æ£€æŸ¥å¹¶å½’æ¡£éå½“æ—¥è®°å½•
            loadedEntries.forEach(entry => {
                const entryDate = new Date(entry.timestamp).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                
                if (entryDate !== todayDateStr) {
                    // éä»Šæ—¥è®°å½•ï¼Œå½’æ¡£
                    entriesToArchive.push(entry);
                } else {
                    // ä»Šæ—¥è®°å½•ï¼Œä¿ç•™
                    currentDayEntries.push(entry);
                }
            });

            // 4. å¦‚æœæœ‰éœ€è¦å½’æ¡£çš„è®°å½•ï¼Œåˆ™è¿›è¡Œå½’æ¡£æ“ä½œ
            if (entriesToArchive.length > 0) {
                historyEntries = [...entriesToArchive, ...historyEntries];
                entries = currentDayEntries; 
                saveEntries(); 
                console.log(`[å½’æ¡£æˆåŠŸ] å·²å°† ${entriesToArchive.length} æ¡æ—§è®°å½•å½’æ¡£ã€‚`);
            } else {
                entries = loadedEntries;
            }
            
            // ç¡®ä¿å†å²æŒ‰é’®æ–‡æœ¬æ›´æ–°
            updateHistoryButtonText();
        }

        function saveEntries() {
            // 1. ä¿å­˜å½“å‰ï¼ˆå½“æ—¥ï¼‰è®°å½•
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
            // 2. ä¿å­˜å†å²è®°å½•
            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(historyEntries));
            
            // ç¡®ä¿å†å²æŒ‰é’®æ–‡æœ¬æ›´æ–°
            updateHistoryButtonText();
        }
        
        function updateHistoryButtonText() {
            viewHistoryBtn.textContent = historyEntries.length > 0 
                ? `æŸ¥çœ‹å†å²è®°å½• (${historyEntries.length} æ¡)` 
                : 'æŸ¥çœ‹å†å²è®°å½• (æš‚æ— )';
        }
        
        /**
         * 4. è®¡ç®—å¹¶æ¸²æŸ“å½“æ—¥æ€»æ”¯å‡º
         */
        function calculateDailyTotal() {
            let dailyTotal = 0;
            entries.forEach(entry => {
                dailyTotal += entry.amount;
            });
            dailyTotalElement.textContent = `ï¿¥${Math.abs(dailyTotal).toFixed(2)}`;
        }


        /**
         * 5. æ¸²æŸ“è®°è´¦åˆ—è¡¨ (åªæ¸²æŸ“å½“æ—¥è®°å½•)
         */
        function renderEntries() {
            entriesList.innerHTML = '';
            calculateDailyTotal();

            let itemRenderedCount = 0;
            
            entries.forEach((entry, originalIndex) => {
                if (itemRenderedCount >= 20) return;

                const item = document.createElement('li');
                item.className = 'entry-item expense';
                const displayAmount = Math.abs(entry.amount).toFixed(2);
                const timeOnly = new Date(entry.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                item.innerHTML = `
                    <div class="entry-description">
                        <span class="desc-text">${entry.description}</span>
                        <span class="desc-time">${timeOnly}</span>
                    </div>
                    <div class="entry-actions">
                        <div class="entry-amount">
                            -ï¿¥${displayAmount}
                        </div>
                        <button class="delete-entry-btn" data-index="${originalIndex}">åˆ é™¤</button>
                    </div>
                `;

                entriesList.appendChild(item);
                itemRenderedCount++;
            });
            
            if (entries.length > 20) {
                 const footer = document.createElement('div');
                 footer.style.textAlign = 'center';
                 footer.style.color = '#999';
                 footer.style.padding = '10px 0';
                 footer.textContent = `... å·²éšè—è¾ƒæ—©çš„ ${entries.length - 20} æ¡ä»Šæ—¥è®°å½•`;
                 entriesList.appendChild(footer);
            }

            if (entries.length === 0) {
                entriesList.innerHTML = '<p style="text-align:center; color:#999;">æš‚æ— ä»Šæ—¥è®°å½•ï¼Œå¼€å§‹è®°è´¦å§ï¼</p>';
            }
        }
        
        /**
         * 6. æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
         */
        function renderHistoryEntries() {
            historyListElement.innerHTML = '';
            
            if (historyEntries.length === 0) {
                historyListElement.innerHTML = '<p style="text-align:center; color:#6c757d;">æš‚æ— å†å²å½’æ¡£è®°å½•ã€‚</p>';
                return;
            }

            // éå†æ‰€æœ‰å†å²è®°å½•
            historyEntries.forEach((entry, index) => {
                const item = document.createElement('li');
                item.className = 'entry-item expense history-entry';
                
                const displayAmount = Math.abs(entry.amount).toFixed(2);
                
                // å†å²è®°å½•æ˜¾ç¤ºå®Œæ•´æ—¥æœŸå’Œæ—¶é—´
                const fullDateTime = new Date(entry.timestamp).toLocaleDateString('zh-CN', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' 
                });

                item.innerHTML = `
                    <div class="entry-description">
                        <span class="desc-text">${entry.description}</span>
                        <span class="desc-time">${fullDateTime}</span>
                    </div>
                    <div class="entry-actions">
                        <div class="entry-amount">
                            -ï¿¥${displayAmount}
                        </div>
                        </div>
                `;

                historyListElement.appendChild(item);
            });
        }
        
        /**
         * 7. å†å²è®°å½•æ¨¡æ€æ¡†æ§åˆ¶
         */
        function openHistoryModal() {
            renderHistoryEntries(); // æ¯æ¬¡æ‰“å¼€æ—¶é‡æ–°æ¸²æŸ“
            historyModal.showModal();
        }
        
        function closeHistoryModal() {
            historyModal.close();
        }
        
        // å°†æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°æš´éœ²ç»™å…¨å±€ (ç”¨äº HTML ä¸­çš„ onclick)
        window.openHistoryModal = openHistoryModal;
        window.closeHistoryModal = closeHistoryModal;

        /**
         * 8. äº‹ä»¶å¤„ç†ï¼šå†å²æŒ‰é’®ç‚¹å‡»
         */
        viewHistoryBtn.addEventListener('click', openHistoryModal);

        // ... çœç•¥äº† inputElement.addEventListener('input') å’Œ formElement.addEventListener('submit') (ä¸åŸä»£ç ä¸€è‡´) ...
        inputElement.addEventListener('input', () => {
            const input = inputElement.value;
            if (input.trim() === '') {
                previewBox.innerHTML = 'è¾“å…¥å†…å®¹åè‡ªåŠ¨è¯†åˆ«...';
                return;
            }

            const parsed = parseInput(input);
            const amountText = 'æ”¯å‡º'; 
            const displayAmount = Math.abs(parsed.amount).toFixed(2);

            previewBox.innerHTML = `
                <p style="margin: 0;">
                    <strong>æè¿°:</strong> ${parsed.description}<br>
                    <strong>é‡‘é¢:</strong> <span style="color: var(--secondary-color);">${amountText} ï¿¥${displayAmount}</span>
                </p>
            `;
        });
        
        inputElement.dispatchEvent(new Event('input')); 
        
        formElement.addEventListener('submit', (e) => {
            e.preventDefault();

            const input = inputElement.value;
            if (input.trim() === '') {
                alert('è¯·è¾“å…¥å†…å®¹ï¼');
                return;
            }

            const parsed = parseInput(input);
            
            if (parsed.amount === 0 && !input.match(/\d/)) {
                alert('æœªè¯†åˆ«åˆ°æœ‰æ•ˆé‡‘é¢ï¼Œè¯·ç¡®ä¿è¾“å…¥ä¸­åŒ…å«æ•°å­—ï¼');
                return;
            }


            const newEntry = {
                description: parsed.description,
                amount: parsed.amount, 
                timestamp: new Date().toISOString()
            };

            entries.unshift(newEntry);
            saveEntries();
            renderEntries(); 

            inputElement.value = '';
            inputElement.dispatchEvent(new Event('input')); 
        });


        /**
         * 9. äº‹ä»¶ä»£ç†å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡» (åªåˆ é™¤å½“æ—¥è®°å½•)
         */
        entriesList.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.classList.contains('delete-entry-btn')) {
                const index = parseInt(target.getAttribute('data-index'));
                
                if (isNaN(index) || index < 0 || index >= entries.length) {
                    console.error("Invalid entry index for deletion.");
                    return;
                }
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤è®°å½•: "${entries[index].description} ï¿¥${Math.abs(entries[index].amount).toFixed(2)}" å—?`)) {
                    entries.splice(index, 1);
                    
                    saveEntries();
                    renderEntries(); 
                }
            }
        });

        // 10. åˆå§‹åŒ–
        loadEntries();
        renderEntries();
        updateHistoryButtonText();

    </script>

</body>

</html>