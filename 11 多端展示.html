<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步工具 v7.2 - API直连+本地压缩版</title>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --card: #ffffff; --success: #34c759; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .main-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        
        .status-bar { font-size: 12px; color: #8e8e93; background: #e5e5ea; padding: 4px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.active { background: #34c759; }

        .card { background: var(--card); border-radius: 18px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); position: relative; width: 100%; box-sizing: border-box; }
        .content-area { font-size: 16px; line-height: 1.6; color: #1c1c1e; white-space: pre-wrap; word-wrap: break-word; min-height: 200px; width: 100%; border: none; padding: 10px; margin: 0 0 55px 0; font-family: inherit; box-sizing: border-box; }
        textarea.content-area { display: none; background: #f9f9fb; outline: none; resize: none; border: 1px solid #efeff4; border-radius: 12px; }

        .action-bar { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 8px; }
        button { padding: 8px 14px; border-radius: 10px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .btn-blur { background: #f0f0f5; color: #333; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }

        .image-wrapper { position: relative; width: 100%; border-radius: 18px; overflow: hidden; background: #e5e5ea; min-height: 220px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); }
        #img-box { width: 100%; height: auto; display: block; opacity: 0; transition: opacity 0.4s; }

        .img-upload-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .image-wrapper:hover .img-upload-overlay { opacity: 1; }
        .upload-btn-icon { background: rgba(255,255,255,0.9); padding: 10px 18px; border-radius: 30px; font-size: 13px; font-weight: 600; color: #333; display: flex; align-items: center; gap: 6px; }

        #toast { position: fixed; top: 30px; background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="status-bar">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">同步引擎加载中...</span>
    </div>

    <div class="card">
        <div id="text-box" class="content-area">正在从 API 获取最新文字...</div>
        <textarea id="edit-area" class="content-area" spellcheck="false"></textarea>
        <div class="action-bar">
            <button id="btn-copy" class="btn-blur">复制</button>
            <button id="btn-edit" class="btn-blur">编辑文字</button>
            <button id="btn-paste" class="btn-success" style="display:none">粘贴覆盖</button>
            <button id="btn-send" class="btn-primary" style="display:none">同步文本</button>
            <button id="btn-cancel" class="btn-blur" style="display:none">取消</button>
        </div>
    </div>

    <div class="image-wrapper">
        <div id="img-loading-text" style="position:absolute; width:100%; text-align:center; top:45%; color:#8e8e93; font-size:13px;">正在从 API 获取最新图片...</div>
        <img id="img-box" />
        <div class="img-upload-overlay" onclick="triggerImageUpload()">
            <div class="upload-btn-icon">更换并压缩上传 (重命名为11.png)</div>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>
</div>

<div id="toast"></div>

<script>
    const CONFIG = { owner: "xgd1062", repo: "1062", txt_path: "111/11.txt", img_path: "111/11.png", branch: "main" };
    const API_TXT = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.txt_path}`;
    const API_IMG = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.img_path}`;

    const textBox = document.getElementById('text-box');
    const editArea = document.getElementById('edit-area');
    const imgBox = document.getElementById('img-box');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    const fileInput = document.getElementById('file-input');

    function showToast(msg, isError=false) {
        const t = document.getElementById('toast');
        t.innerText = msg; 
        t.style.backgroundColor = isError ? 'rgba(220,53,69,0.9)' : 'rgba(0,0,0,0.85)';
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2500);
    }

    // --- 新增：图片压缩工具函数 ---
    function compressImage(file, quality = 0.7, maxWidth = 1280) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    // 1. 创建 Canvas
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // 2. 尺寸限制 (如果宽度大于 maxWidth 则等比缩放)
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;

                    // 3. 在 Canvas 上绘制
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 4. 导出压缩后的 JPEG Base64 (弃用透明度以获得更高压缩比)
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    // 5. 返回纯 Base64 字符串（去掉 data:image/jpeg;base64, 前缀）
                    resolve(compressedDataUrl.split(',')[1]);
                };
                img.onerror = (err) => reject(err);
            };
            reader.onerror = (err) => reject(err);
        });
    }


    // --- 原有核心逻辑 ---
    async function initAllData() {
        const token = localStorage.getItem('gh_token');
        const headers = token ? { "Authorization": `token ${token}` } : {};
        statusDot.classList.remove('active');
        
        try {
            // 1. 获取文字
            const resTxt = await fetch(`${API_TXT}?t=${Date.now()}`, { headers, cache: 'no-store' });
            if (resTxt.ok) {
                const dataTxt = await resTxt.json();
                textBox.innerText = decodeURIComponent(escape(atob(dataTxt.content)));
            }

            // 2. 获取图片 (直接拿 API 返回的 Base64)
            const resImg = await fetch(`${API_IMG}?t=${Date.now()}`, { headers, cache: 'no-store' });
            if (resImg.ok) {
                const dataImg = await resImg.json();
                const pureBase64 = dataImg.content.replace(/\s/g, '');
                imgBox.src = `data:image/png;base64,${pureBase64}`; // API 返回的原图可能是 PNG
                imgBox.onload = () => {
                    imgBox.style.opacity = 1;
                    document.getElementById('img-loading-text').style.display = 'none';
                };
            }
            statusText.innerText = token ? "全 API 直连 - 实时模式" : "匿名预览 (只读)";
            statusDot.classList.add('active');
        } catch (e) {
            statusText.innerText = "API 连接失败，请检查网络或 Token";
        }
    }

    // 文字逻辑省略，保持 v7.1 不变...
    document.getElementById('btn-edit').onclick = () => {
        if (!localStorage.getItem('gh_token')) {
            const t = prompt("请输入 Token:");
            if (t) { localStorage.setItem('gh_token', t); initAllData(); }
        } else { toggleTextUI(true); }
    };
    async function toggleTextUI(isEdit) {
        textBox.style.display = isEdit ? 'none' : 'block';
        editArea.style.display = isEdit ? 'block' : 'none';
        ['btn-copy', 'btn-edit'].forEach(id => document.getElementById(id).style.display = isEdit ? 'none' : 'flex');
        ['btn-paste', 'btn-send', 'btn-cancel'].forEach(id => document.getElementById(id).style.display = isEdit ? 'flex' : 'none');
        if(isEdit) { editArea.value = textBox.innerText; editArea.style.height = (textBox.offsetHeight > 200 ? textBox.offsetHeight : 200) + 'px'; editArea.focus(); }
    }
    document.getElementById('btn-send').onclick = async () => {
        const token = localStorage.getItem('gh_token');
        const btn = document.getElementById('btn-send');
        btn.disabled = true; btn.innerText = "正在推送...";
        try {
            const getRes = await fetch(`${API_TXT}?t=${Date.now()}`, { headers: { "Authorization": `token ${token}` }, cache: 'no-store' });
            const fileData = await getRes.json();
            const putRes = await fetch(API_TXT, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: "Update Text",
                    content: btoa(unescape(encodeURIComponent(editArea.value))),
                    sha: fileData.sha, branch: CONFIG.branch
                })
            });
            if (putRes.ok) { showToast("文字已更新"); toggleTextUI(false); initAllData(); }
        } catch (e) { showToast("同步失败，Token 可能失效", true); } finally { btn.disabled = false; btn.innerText = "同步文本"; }
    };
    document.getElementById('btn-cancel').onclick = () => toggleTextUI(false);
    document.getElementById('btn-copy').onclick = () => { navigator.clipboard.writeText(textBox.innerText); showToast("已复制"); };
    document.getElementById('btn-paste').onclick = async () => { editArea.value = await navigator.clipboard.readText(); };


    // --- 图片上传逻辑 (集成压缩) ---
    function triggerImageUpload() {
        if (!localStorage.getItem('gh_token')) {
            const t = prompt("请先输入 Token:");
            if (t) { localStorage.setItem('gh_token', t); initAllData(); }
        } else { fileInput.click(); }
    }

    // 修改点：选择文件后先压缩，再上传
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        showToast("正在处理并压缩图片...");
        
        try {
            // 1. 执行压缩 (质量 0.7, 最大宽度 1280px)
            const compressedBase64 = await compressImage(file, 0.7, 1280);
            // 2. 执行上传
            await uploadImage(compressedBase64);
        } catch(err) {
            showToast("图片处理失败: " + err.message, true);
        } finally {
            fileInput.value = ''; // 清空以便下次重复选择
        }
    };

    async function uploadImage(base64) {
        const token = localStorage.getItem('gh_token');
        showToast("正在上传压缩后的图片...");
        try {
            let sha = null;
            const g = await fetch(`${API_IMG}?t=${Date.now()}`, { headers: { "Authorization": `token ${token}` }, cache: 'no-store' });
            if (g.ok) { const d = await g.json(); sha = d.sha; }
            
            const p = await fetch(API_IMG, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: "Update Compressed Image to 11.png",
                    content: base64,
                    sha: sha,
                    branch: CONFIG.branch
                })
            });
            if (p.ok) { 
                showToast("图片同步成功！"); 
                // 稍微延迟一下再刷新，让 GitHub 服务器有时间处理
                setTimeout(initAllData, 1000); 
            } else { throw new Error("API Error"); }
        } catch (e) { showToast("图片上传失败", true); }
    }

    // 初始化
    initAllData();
</script>
</body>
</html>